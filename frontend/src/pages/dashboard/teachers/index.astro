<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <form id="AddTeacher">
      <button type="submit"> Añadir Profesor </button>
    </form>
    <table id="teachersTable" border={1}>
      <thead>
        <tr>
          <th>#</th>
          <th>Nombre</th>
          <th>Celuar Contacto</th>
          <th>Email Contacto</th>
          <th>Role</th>
          <th>Editar</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody> </tbody>
    </table>
    <script>
      const addTeacherForm = document.querySelector("#AddTeacher");
      addTeacherForm?.addEventListener("submit", (event) => {
        event.preventDefault();
        window.location.href = "/dashboard/teachers/add";
      });

      const tableBodyTeachers = document.querySelector("#teachersTable tbody");

      if (tableBodyTeachers) {
        tableBodyTeachers.innerHTML = "";
        const res = fetch("http://localhost:3001/api/users");
        res
          .then((response) => response.json())
          .then((users) => {
            let numero = 1;
            users.forEach((user) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                        <td>${numero}</td>
                        <td>${user.name}</td>
                        <td>${user.cel}</td>
                        <td>${user.email}</td>
                        <td>${user.role}</td>
                        
                        <td><a href="/dashboard/teachers/${user.id}/edit">Editar</a></td>
                        <td><button class="btn-elimina" data-id=${user.id}>Eliminar</button></td>
                        `;
              numero += 1;
              tableBodyTeachers.appendChild(row);
            });
          })
          .catch((error) => console.error("Error fetching users:", error));
      }

      document.addEventListener("DOMContentLoaded", () => {
        document.body.addEventListener("click", async (event) => {
          const button = (event.target as HTMLElement).closest(
            ".btn-elimina"
          ) as HTMLButtonElement;
          if (!button) return;

          const id = button.dataset.id;
          if (!id) return;

          const confirmar = confirm("¿Estás seguro de eliminar este profesor?");
          if (!confirmar) return;

          try {
            const response = await fetch(
              `http://localhost:3001/api/users/${id}`,
              {
                method: "DELETE",
              }
            );

            if (response.ok) {
              alert("Profesor eliminado exitosamente");
              window.location.reload();
            } else {
              let errorMsg;
              try {
                const errorData = await response.json();
                errorMsg = errorData.message || JSON.stringify(errorData);
              } catch {
                errorMsg = await response.text();
              }
              alert("Error eliminando Profesor: " + errorMsg);
            }
          } catch (err) {
            console.error(err);
            alert("Error eliminando Profesor");
          }
        });
      });
    </script>
  </body>
</html>
