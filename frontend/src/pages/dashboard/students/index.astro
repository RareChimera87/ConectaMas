<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <table id="studentsTable" border={1}>
      <thead>
        <tr>
          <th>#</th>
          <th>ID</th>
          <th>Nombre</th>
          <th>Celuar Contacto</th>
          <th>Email Contacto</th>
          <th>Edad</th>
          <th>Deficiencia</th>
          <th>Evaluacion</th>
          <th>Editar</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody> </tbody>
    </table>
    <script>
      const tableBodyStudents = document.querySelector("#studentsTable tbody");

      if (tableBodyStudents) {
        tableBodyStudents.innerHTML = "";
        const res = fetch("http://localhost:3001/api/students");
        res
          .then((response) => response.json())
          .then((users) => {
            let numero = 1;
            users.forEach((user) => {
              const row = document.createElement("tr");
              row.innerHTML = `
                        <td>${numero}</td>
                        <td>${user.id}</td>
                        <td>${user.name}</td>
                        <td>${user.cel_contact}</td>
                        <td>${user.email_contact}</td>
                        <td>${user.age}</td>
                        <td>${user.deficiency}</td>
                        
                        <td><a href="/dashboard/students/${user.id}/info">Informacion</a></td>
                        <td><a href="/dashboard/students/${user.id}/edit">Editar</a></td>
                        <td><button class="btn-elimina" data-id=${user.id}>Eliminar</button></td>
                    `;
              numero += 1;
              tableBodyStudents.appendChild(row);
            });
          })
          .catch((error) => console.error("Error fetching users:", error));
      }

      document.addEventListener("DOMContentLoaded", () => {
        document.body.addEventListener("click", async (event) => {
          const button = (event.target as HTMLElement).closest(
            ".btn-elimina"
          ) as HTMLButtonElement;
          if (!button) return;

          const id = button.dataset.id;
          if (!id) return;

          const confirmar = confirm(
            "¿Estás seguro de eliminar este estudiante?"
          );
          if (!confirmar) return;

          try {
            const response = await fetch(
              `http://localhost:3001/api/students/${id}`,
              {
                method: "DELETE",
              }
            );

            if (response.ok) {
              alert("Estudiante eliminado exitosamente");
              window.location.reload();
            } else {
              let errorMsg;
              try {
                const errorData = await response.json();
                errorMsg = errorData.message || JSON.stringify(errorData);
              } catch {
                errorMsg = await response.text();
              }
              alert("Error eliminando estudiante: " + errorMsg);
            }
          } catch (err) {
            console.error(err);
            alert("Error eliminando estudiante");
          }
        });
      });
    </script>
  </body>
</html>
